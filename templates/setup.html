{{define "setup-content"}}
<div class="setup-container">
    <div class="setup-card">
        <h2>ðŸ”§ Setup Required</h2>
        <p>Welcome to Gumroad License Manager! To get started, please enter your Gumroad access token.</p>
        
        <div class="info-section">
            <h3>How to get your Gumroad access token:</h3>
            <ol>
                <li>Visit <a href="https://gumroad.com/api" target="_blank">Gumroad API Settings</a></li>
                <li>Log in to your Gumroad account</li>
                <li>Generate or copy your access token</li>
                <li>Paste it in the form below</li>
            </ol>
        </div>

        <form id="tokenForm" class="token-form">
            <div class="form-group">
                <label for="token">Gumroad Access Token:</label>
                <div class="input-wrapper">
                    <input type="password" id="token" name="token" placeholder="Enter your Gumroad access token" required>
                    <button type="button" id="toggleToken" class="toggle-btn">Show</button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Token & Continue</button>
        </form>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tokenForm = document.getElementById('tokenForm');
    const tokenInput = document.getElementById('token');
    const toggleBtn = document.getElementById('toggleToken');
    const errorMsg = document.getElementById('error-message');
    const successMsg = document.getElementById('success-message');

    // Toggle password visibility
    toggleBtn.addEventListener('click', function() {
        if (tokenInput.type === 'password') {
            tokenInput.type = 'text';
            toggleBtn.textContent = 'Hide';
        } else {
            tokenInput.type = 'password';
            toggleBtn.textContent = 'Show';
        }
    });

    // Handle form submission
    tokenForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const token = tokenInput.value.trim();
        if (!token) {
            showError('Please enter a valid token');
            return;
        }

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> Saving...';
        
        hideMessages();

        try {
            const response = await fetch('/setup/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: token })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showSuccess('Token saved successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } else {
                showError(result.error || 'Failed to save token');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        successMsg.style.display = 'none';
    }

    function showSuccess(message) {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
    }

    function hideMessages() {
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';
    }
});
</script>
{{end}}
